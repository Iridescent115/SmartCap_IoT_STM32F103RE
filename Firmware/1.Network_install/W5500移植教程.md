# W5500以太网模块移植教程

## 📋 目录
1. [硬件连接说明](#硬件连接说明)
2. [CubeMX工程配置](#cubemx工程配置)
3. [文件移植步骤](#文件移植步骤)
4. [代码集成](#代码集成)
5. [测试验证](#测试验证)
6. [常见问题](#常见问题)

---

## 🔌 硬件连接说明

### 芯片说明
- **目标MCU**: STM32F103RET6
- **封装**: LQFP64（64引脚）
- **Flash**: 512KB
- **RAM**: 64KB
- **与VCT6的区别**: RET6引脚较少，无PD/PE端口，但功能足够W5500使用

### W5500模块引脚连接
**根据您的硬件原理图，STM32F103RET6的实际连接：**

| W5500信号 | STM32引脚 | 功能说明 |
|-----------|-----------|----------|
| SPI_SCS (片选) | **PC9** | SPI片选信号（开漏输出+上拉）|
| SPI_SCLK (时钟) | **PB13** | SPI2_SCK |
| SPI_MISO (主入从出) | **PB14** | SPI2_MISO |
| SPI_MOSI (主出从入) | **PB15** | SPI2_MOSI |
| RST_L (复位) | **PC4** | 复位引脚（开漏输出+上拉）|
| INT_L (中断) | **PC5** | 中断引脚（可选，本例程未使用）|
| VCC | 3.3V | 电源 |
| GND | GND | 地 |

**注意事项：**
- W5500工作电压为3.3V
- SPI_SCS和RST_L引脚需要配置为开漏输出模式并启用上拉电阻
- 以上引脚连接已根据您的硬件原理图确定，**请勿随意更改**
- SPI2使用PB13/14/15引脚
- 控制信号使用PC4/PC5/PC9引脚

---

## ⚙️ CubeMX工程配置

### 第1步：创建新工程
1. 打开STM32CubeMX
2. 选择您的MCU型号：**STM32F103RET6**（LQFP64封装）
   - 原例程使用STM32F103VCT6（LQFP100封装）
   - RET6引脚较少，需要注意引脚选择
3. 点击 `Start Project`

### 第2步：RCC配置（时钟源）
1. 左侧找到 `RCC`
2. 设置：
   - `HSE`: Crystal/Ceramic Resonator（外部晶振，如8MHz）
   - 或根据您的硬件选择HSI

### 第3步：SPI2配置
1. 左侧找到 `SPI2`
2. 配置：
   - `Mode`: Full-Duplex Master（全双工主模式）
   - `Hardware NSS Signal`: Disable（软件控制片选）

3. Parameter Settings（参数设置）：
   ```
   Frame Format: Motorola
   Data Size: 8 Bits
   First Bit: MSB First
   
   Prescaler: 根据您的系统时钟设置
   - 建议SPI时钟不超过33MHz
   - 例程使用：BaudRate Prescaler = 2
   
   Clock Polarity (CPOL): Low
   Clock Phase (CPHA): 1 Edge
   CRC Calculation: Disabled
   NSS Signal Type: Software
   ```

### 第4步：GPIO配置
配置以下GPIO引脚：

**1. SPI引脚（自动配置）**
- PB13: SPI2_SCK
- PB14: SPI2_MISO  
- PB15: SPI2_MOSI

**2. 手动配置控制引脚**

**PC9 (SPI_SCS - 片选)**
```
GPIO output level: High
GPIO mode: Output Open Drain
GPIO Pull-up/Pull-down: Pull-up
Maximum output speed: High
User Label: SCSn
```

**PC4 (RST_L - 复位)**
```
GPIO output level: High
GPIO mode: Output Open Drain
GPIO Pull-up/Pull-down: Pull-up
Maximum output speed: High
User Label: RSTn
```

**PC5 (INT_L - 中断，可选)**
```
GPIO mode: Input mode
GPIO Pull-up/Pull-down: No pull-up and no pull-down
User Label: INTn
```

> **重要提示：** 
> - 以上引脚配置必须与您的硬件原理图一致
> - **User Label必须严格按照上述设置**（SCSn、RSTn、INTn），这样代码才能自动识别
> - PC9、PC4、PC5是您硬件上已固定的引脚，不可更改

### 第5步：TIM2配置（1ms定时器）
1. 左侧找到 `TIM2`
2. 配置：
   - `Clock Source`: Internal Clock
   
3. Parameter Settings：
   ```
   假设系统时钟72MHz，APB1时钟36MHz（×2=72MHz）
   
   Prescaler (PSC): 72-1     （72分频）
   Counter Period (ARR): 1000-1  （计数1000次）
   
   定时器频率 = 72MHz / 72 / 1000 = 1kHz (1ms)
   ```

4. NVIC Settings：
   - 勾选 `TIM2 global interrupt`（启用TIM2中断）

### 第6步：USART1配置（用于printf调试）
1. 左侧找到 `USART1`
2. 配置：
   - `Mode`: Asynchronous（异步模式）
   - `Baud Rate`: 115200
   - `Word Length`: 8 Bits
   - `Parity`: None
   - `Stop Bits`: 1

### 第7步：时钟树配置
1. 点击顶部 `Clock Configuration` 标签
2. 配置系统时钟（根据您的硬件晶振频率调整）：
   ```
   Input frequency: 8MHz (HSE) 或根据您的实际晶振
   PLLMUL: x9 (得到72MHz)
   System Clock: 72MHz
   APB1 Prescaler: /2 (36MHz)
   APB2 Prescaler: /1 (72MHz)
   ```
   
   **注意：** 如果您的硬件使用其他频率的晶振（如12MHz、16MHz等），请相应调整PLLMUL倍频系数

### 第8步：工程设置
1. 点击顶部 `Project Manager` 标签
2. `Project` 页面：
   - Project Name: 填写工程名
   - Project Location: 选择保存路径
   - Toolchain/IDE: 选择您使用的IDE（如MDK-ARM V5）

3. `Code Generator` 页面：
   - 勾选 `Copy only the necessary library files`
   - 勾选 `Generate peripheral initialization as a pair of '.c/.h' files per peripheral`

### 第9步：生成代码
1. 点击右上角 `GENERATE CODE`
2. 等待生成完成
3. 点击 `Open Project` 打开工程

---

## 📁 文件移植步骤

### 第1步：复制ioLibrary驱动库

从官方例程复制以下文件夹到您的工程目录：

```
您的工程/
└── User/
    └── ioLibrary_Driver/
        ├── Ethernet/
        │   ├── W5500/
        │   │   ├── w5500.c
        │   │   └── w5500.h
        │   ├── socket.c
        │   ├── socket.h
        │   ├── wizchip_conf.c
        │   └── wizchip_conf.h
        └── Internet/
            └── DHCP/
                ├── dhcp.c
                └── dhcp.h
```

**复制路径：**
```
官方例程/User/ioLibrary_Driver/Ethernet/  →  您的工程/User/ioLibrary_Driver/Ethernet/
官方例程/User/ioLibrary_Driver/Internet/  →  您的工程/User/ioLibrary_Driver/Internet/
```

### 第2步：复制用户代码文件

从官方例程复制以下文件到您的工程：

```
您的工程/
└── User/
    ├── user_main/
    │   ├── user_main.c
    │   └── user_main.h
    ├── wiz_interface/
    │   ├── wiz_interface.c
    │   └── wiz_interface.h
    └── wiz_platform/
        ├── wiz_platform.c
        └── wiz_platform.h
```

**这些文件的作用：**
- `user_main.*`: 用户主程序，包含网络初始化和应用逻辑
- `wiz_interface.*`: W5500接口层，包含初始化、定时器管理等
- `wiz_platform.*`: 硬件平台适配层，包含SPI读写、GPIO控制等

### 第3步：添加文件到IDE工程

以MDK-ARM为例：

1. 在工程中创建组（Group）：
   ```
   Application/User
   ├── user_main
   ├── wiz_interface  
   └── wiz_platform
   
   Drivers/ioLibrary
   ├── Ethernet
   └── Internet/DHCP
   ```

2. 添加源文件：
   - 右键组 → `Add Existing Files to Group`
   - 选择对应的.c文件添加

### 第4步：配置包含路径

在IDE中添加头文件搜索路径（MDK中为C/C++ → Include Paths）：

```
../User/user_main
../User/wiz_interface
../User/wiz_platform
../User/ioLibrary_Driver/Ethernet
../User/ioLibrary_Driver/Ethernet/W5500
../User/ioLibrary_Driver/Internet/DHCP
```

---

## 💻 代码集成

### 第1步：修改main.c

在 `Core/Src/main.c` 中添加用户代码：

```c
/* USER CODE BEGIN Includes */
#include "user_main.h"
/* USER CODE END Includes */

int main(void)
{
  HAL_Init();
  SystemClock_Config();
  
  MX_GPIO_Init();
  MX_USART1_UART_Init();
  MX_SPI2_Init();
  MX_TIM2_Init();
  
  /* USER CODE BEGIN 2 */
  user_run();  // 启动W5500和网络应用
  /* USER CODE END 2 */

  while (1)
  {
    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}
```

### 第2步：检查硬件引脚定义

**重要：** 您的硬件引脚与原例程不同，**必须确认**以下配置：

打开 `User/wiz_platform/wiz_platform.c`，检查引脚定义是否与您的硬件一致：

```c
// 片选引脚（您的硬件使用PC9）
void wizchip_select(void)
{
    HAL_GPIO_WritePin(SCSn_GPIO_Port, SCSn_Pin, GPIO_PIN_RESET);
    //                ↑ 这里的引脚名应与CubeMX中设置的User Label一致
}

// 复位引脚（您的硬件使用PC4）
void wizchip_reset(void)
{
    HAL_GPIO_WritePin(RSTn_GPIO_Port, RSTn_Pin, GPIO_PIN_SET);
    //                ↑ 这里的引脚名应与CubeMX中设置的User Label一致
    ...
}
```

**根据您的硬件原理图，CubeMX配置必须如下：**
1. 在CubeMX中将控制引脚配置为：
   - **PC9（SPI_SCS片选）** → User Label必须设为 **"SCSn"**
   - **PC4（RST_L复位）** → User Label必须设为 **"RSTn"**
   - **PC5（INT_L中断）** → User Label必须设为 **"INTn"**（可选）
2. 只要User Label设置正确，代码中的宏定义会自动匹配，**无需手动修改代码**
3. 这些引脚是您硬件上已经确定的，不可更改

### 第3步：检查SPI和定时器句柄

打开 `User/wiz_platform/wiz_platform.c`，确认句柄名称：

```c
extern SPI_HandleTypeDef hspi2;   // 应与您使用的SPI一致
extern UART_HandleTypeDef huart1; // 用于printf
extern TIM_HandleTypeDef htim2;   // 1ms定时器
```

如果使用不同的外设，需要修改这些句柄名。

### 第4步：配置网络参数

打开 `User/user_main/user_main.c`，修改网络配置：

```c
/* 网络信息 */
wiz_NetInfo default_net_info = {
    .mac = {0x00, 0x08, 0xdc, 0x12, 0x22, 0x12},  // MAC地址（建议改成唯一值）
    .ip = {192, 168, 1, 110},                      // 静态IP地址
    .gw = {192, 168, 1, 1},                        // 网关
    .sn = {255, 255, 255, 0},                      // 子网掩码
    .dns = {8, 8, 8, 8},                           // DNS服务器
    .dhcp = NETINFO_STATIC                         // NETINFO_STATIC或NETINFO_DHCP
};
```

**使用DHCP自动获取IP：**
```c
.dhcp = NETINFO_DHCP  // 改为DHCP模式
```

---

## 🧪 测试验证

### 第1步：编译工程
1. 编译工程，确保没有错误
2. 常见编译错误：
   - 缺少头文件路径 → 检查Include Paths配置
   - 重复定义 → 检查是否重复添加了源文件

### 第2步：下载程序
1. 连接STLink或其他调试器
2. 下载程序到MCU

### 第3步：查看串口输出
1. 打开串口调试助手（115200波特率）
2. 复位MCU，应该看到类似输出：

```
wizchip 网络配置示例
PHY 已连接
当前速率 : 100Mbps
当前双工模式 : 全双工
====================================================================================================
 W5500 网络配置 : 静态

 MAC         : 00:08:DC:12:22:12
 IP          : 192.168.1.110
 子网掩码    : 255.255.255.0
 网关        : 192.168.1.1
 DNS         : 8.8.8.8
====================================================================================================

请尝试 ping 192.168.1.110
```

### 第4步：网络测试
1. 确保PC与W5500在同一网段
2. 在PC上打开命令提示符
3. 执行ping命令：
   ```
   ping 192.168.1.110
   ```
4. 应该能成功ping通

---

## ❓ 常见问题

### Q1: 串口无输出或乱码
**解决方法：**
- 检查波特率是否为115200
- 确认USART1引脚连接正确
- 检查是否包含了printf重定向代码（在wiz_platform.c中）

### Q2: 提示"PHY 未连接"
**可能原因：**
- 网线未插好
- W5500供电不足
- SPI通信失败
- 复位引脚配置错误

**解决方法：**
- 检查网线连接和指示灯
- 测量W5500的3.3V供电
- 用示波器检查SPI信号
- 检查RSTn引脚是否为开漏+上拉模式

### Q3: 无法ping通
**可能原因：**
- IP地址配置错误（不在同一网段）
- 网关配置错误
- 防火墙阻止
- MAC地址冲突

**解决方法：**
- 确认PC和W5500在同一网段（如都是192.168.1.x）
- 暂时关闭PC防火墙测试
- 修改MAC地址为唯一值

### Q4: 编译错误 - 找不到头文件
**解决方法：**
- 检查Include Paths是否正确添加
- 确认文件已正确复制到工程目录
- 使用相对路径（../ 表示上级目录）

### Q5: DHCP获取失败
**可能原因：**
- 网络中没有DHCP服务器
- 超时时间太短
- SPI通信不稳定

**解决方法：**
- 先使用静态IP测试，确认硬件无问题
- 检查路由器DHCP是否开启
- 增加DHCP超时时间

### Q6: SPI通信错误
**检查项：**
- SPI时钟极性和相位设置（CPOL=0, CPHA=0）
- SPI时钟频率不要超过33.3MHz
- 片选引脚控制逻辑（低电平有效）
- 使用示波器观察波形

---

## 📝 代码结构说明

```
工程文件结构：
├── Core/                       # STM32 HAL库生成的代码
│   ├── Src/
│   │   ├── main.c             # 主程序（调用user_run）
│   │   ├── spi.c              # SPI初始化
│   │   ├── tim.c              # 定时器初始化
│   │   ├── usart.c            # 串口初始化
│   │   └── gpio.c             # GPIO初始化
│   └── Inc/                   # 头文件
│
└── User/                       # 用户代码
    ├── user_main/             # 用户主程序
    │   ├── user_main.c        # 网络初始化、应用逻辑
    │   └── user_main.h
    │
    ├── wiz_interface/         # W5500接口层
    │   ├── wiz_interface.c    # wizchip初始化、定时器、网络配置
    │   └── wiz_interface.h
    │
    ├── wiz_platform/          # 硬件平台层
    │   ├── wiz_platform.c     # SPI读写、GPIO控制、printf重定向
    │   └── wiz_platform.h
    │
    └── ioLibrary_Driver/      # WIZnet官方驱动库
        ├── Ethernet/          # 以太网底层驱动
        │   ├── W5500/
        │   │   ├── w5500.c    # W5500寄存器操作
        │   │   └── w5500.h
        │   ├── socket.c       # Socket API
        │   ├── socket.h
        │   ├── wizchip_conf.c # 芯片配置
        │   └── wizchip_conf.h
        │
        └── Internet/          # 网络协议栈
            └── DHCP/
                ├── dhcp.c     # DHCP客户端
                └── dhcp.h
```

---

## 🚀 下一步学习

移植成功后，您可以：

1. **学习Socket编程**
   - TCP服务器/客户端
   - UDP通信
   - 参考例程中的其他示例

2. **使用其他协议**
   - HTTP服务器
   - MQTT客户端
   - FTP服务器
   - DNS解析

3. **优化和扩展**
   - 添加看门狗
   - 实现断线重连
   - 数据加密传输
   - 多Socket应用

---

## 📚 参考资料

- [W5500数据手册](https://www.wiznet.io/product-item/w5500/)
- [ioLibrary驱动库GitHub](https://github.com/Wiznet/ioLibrary_Driver)
- [WIZnet官方Wiki](https://wizwiki.net/)

---

**祝您移植顺利！如有问题，欢迎查阅官方文档或在社区提问。**
