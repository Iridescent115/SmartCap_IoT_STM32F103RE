# RG200U AT指令手动测试手册

## 测试目的
手动发送AT指令,验证RG200U模块的各项功能,特别是TCP连接和URC通知功能。

---

## 测试环境准备

### 硬件连接
- **RG200U UART** ↔ **USB转串口模块**
- **波特率**: 115200
- **数据位**: 8
- **停止位**: 1
- **校验位**: None
- **流控**: None

### 软件工具
- 串口调试助手 (如: SSCOM, Tera Term, PuTTY等)
- 确保发送时选择"发送新行"或手动添加 `\r\n`

---

## 初始化测试流程

### 步骤1: 测试基本通信

#### 1.1 测试AT指令
**发送**:
```
AT
```

**期望响应**:
```
AT

OK
```

**说明**: 如果收到 `OK`,表示模块通信正常。

---

### 步骤2: 配置URC通知端口

#### 2.1 查询当前URC配置
**发送**:
```
AT+QURCCFG="urcport"
```

**期望响应**:
```
+QURCCFG: "urcport","uart1"

OK
```

#### 2.2 设置URC输出到所有端口
**发送**:
```
AT+QURCCFG="urcport","all"
```

**期望响应**:
```
OK
```

**说明**: 这条命令**非常重要**!它确保TCP接收通知会发送到所有串口(包括主UART和USB调试口)。

---

### 步骤3: 检查网络注册状态

#### 3.1 检查5G注册状态
**发送**:
```
AT+C5GREG?
```

**期望响应** (已注册5G):
```
+C5GREG: 0,1

OK
```
或者
```
+C5GREG: 0,5

OK
```

**说明**:
- `0,1`: 已注册本地网络
- `0,5`: 已注册漫游网络
- `0,0`: 未注册,未搜索
- `0,2`: 未注册,正在搜索

#### 3.2 检查4G注册状态(如果5G未注册)
**发送**:
```
AT+CEREG?
```

**期望响应** (已注册4G):
```
+CEREG: 0,1

OK
```

---

### 步骤4: 查询运营商信息

**发送**:
```
AT+COPS?
```

**期望响应**:
```
+COPS: 0,0,"CHN-UNICOM",13

OK
```

**说明**: 显示当前运营商名称和网络类型。

---

### 步骤5: 激活数据连接

#### 5.1 检查当前连接状态
**发送**:
```
AT+QNETDEVCTL?
```

**期望响应**:
```
+QNETDEVCTL: 1,1,1

OK
```

#### 5.2 激活数据连接
**发送**:
```
AT+QNETDEVCTL=1,1,1
```

**期望响应**:
```
OK
```
或者
```
ERROR
```
(如果已经激活会返回ERROR,这是正常的)

---

### 步骤6: 查询IP地址

**发送**:
```
AT+CGPADDR
```

**期望响应**:
```
+CGPADDR: 1,"100.76.245.80","2408:8440:630:3685:1891:9a8d:f9f1:e5b9"

OK
```

**说明**: 
- 第一个IP是IPv4地址
- 第二个IP是IPv6地址(用于TCP连接)

---

## TCP连接测试

### 步骤7: 连接TCP服务器

#### 7.1 发送连接命令
**发送**:
```
AT+QIOPEN=1,0,"TCP","2401:ce00:c5af:75d0::f8a",8080,0,0
```

**参数说明**:
- `1`: contextID (数据连接ID)
- `0`: connectID (socket ID)
- `"TCP"`: 协议类型
- `"2401:ce00:c5aa:7ed0::15e"`: 服务器IPv6地址
- `8080`: 服务器端口
- `0`: 本地端口(0表示自动分配)
- `0`: access_mode (0=Buffer模式)

**立即收到**:
```
AT+QIOPEN=1,0,"TCP","2401:ce00:c5af:75d0::f8a",8080,0,0

OK
```

**3-5秒后收到** (异步响应):
```
+QIOPEN: 0,0
```

**说明**:
- `+QIOPEN: 0,0` - 第一个0是connectID,第二个0是错误码
- **错误码=0**: 连接成功 ✅
- **错误码≠0**: 连接失败,常见错误码:
  - `552`: Unknown error
  - `553`: Blocked by firewall
  - `554`: DNS resolution failed / Network busy
  - `555`: Connection timeout
  - `556`: Network not activated
  - `566`: DNS parse failed

#### 7.2 检查连接状态
**发送**:
```
AT+QISTATE?
```

**期望响应** (连接成功):
```
+QISTATE: 0,"TCP","2401:ce00:c5aa:7ed0::15e",8080,48874,3,1,0,0

OK
```

**参数说明**:
- `0`: connectID
- `"TCP"`: 协议
- 服务器IP和端口
- `48874`: 本地端口
- `3`: 连接状态(3=已连接)

---

## TCP数据收发测试

### 步骤8: 接收服务器数据

#### 8.1 服务器发送数据后
当Python服务器发送数据后,串口应该**自动收到URC通知**:

**自动收到**:
```
+QIURC: "recv",0
```

**说明**:
- `"recv"`: 收到数据通知
- `0`: connectID

**如果没收到这条通知,说明URC配置有问题!**

#### 8.2 读取TCP数据
收到 `+QIURC: "recv",0` 通知后,发送读取命令:

**发送**:
```
AT+QIRD=0,1500
```

**期望响应**:
```
+QIRD: 17
Hello from Server!

OK
```

**说明**:
- `17`: 实际数据长度
- 下一行是实际数据内容
- 最后是OK

---

### 步骤9: 发送数据到服务器

**发送**:
```
AT+QISEND=0,13
```

**期望响应**:
```
>
```

**然后立即发送数据** (13字节):
```
Hello Server!
```

**期望响应**:
```
SEND OK
```

---

## 关闭连接

### 步骤10: 关闭TCP连接

**发送**:
```
AT+QICLOSE=0
```

**期望响应**:
```
OK
```

---

## 故障排查

### 问题1: 收不到 `+QIURC: "recv",0` 通知

**可能原因**:
1. URC未配置或配置未生效
2. 数据已在缓冲区但没有触发通知
3. URC配置时机问题(连接后才配置)
4. 固件版本问题

**诊断步骤**:

**步骤1: 直接尝试读取数据**
```
AT+QIRD=0,1500
```
如果能读到数据,说明URC配置有问题;如果读不到,说明服务器没发送成功。

**步骤2: 验证URC配置**
```
AT+QURCCFG="urcport"
```
必须返回 `+QURCCFG: "urcport","all"`

**步骤3: 启用recv URC通知**
```
AT+QINDCFG="recv",1,1
```
这条命令启用TCP接收通知功能。

**步骤4: 断开重连,确保配置顺序正确**
```
AT+QICLOSE=0
AT+QURCCFG="urcport","all"
AT+QINDCFG="recv",1,1
AT+QIOPEN=1,0,"TCP","2401:ce00:c5af:75d0::f8a",8080,0,0
```

**步骤5: 尝试Direct Push模式**
```
AT+QICLOSE=0
AT+QIOPEN=1,0,"TCP","2401:ce00:c5af:75d0::f8a",8080,0,1
                                                         ↑ access_mode=1
```
在此模式下数据会自动推送,无需URC。

### 问题2: `+QIOPEN` 返回错误码554

**可能原因**:
- DNS解析失败
- 网络繁忙
- IP地址格式错误

**解决方案**:
- 确认服务器IP地址正确
- 检查网络连接状态
- 稍后重试

### 问题3: `+QIOPEN` 返回错误码555

**可能原因**:
- 服务器未启动
- 服务器端口未监听
- 防火墙阻止

**解决方案**:
- 确认Python服务器正在运行
- 检查服务器监听 `[::]:8080`
- 检查防火墙规则

### 问题4: AT+QIRD 返回空数据

**可能原因**:
- 数据已被读取
- 实际无数据

**解决方案**:
- 确认收到 `+QIURC` 通知后才读取
- 服务器重新发送数据

---

## 完整测试脚本

按顺序依次发送以下命令(每条命令等待响应后再发下一条):

```
1. AT
2. AT+QURCCFG="urcport","all"
3. AT+C5GREG?
4. AT+CEREG?
5. AT+COPS?
6. AT+QNETDEVCTL=1,1,1
7. AT+CGPADDR
8. AT+QIOPEN=1,0,"TCP","2401:ce00:c5aa:7ed0::15e",8080,0,0
   (等待3-5秒,应该收到 +QIOPEN: 0,0)
9. AT+QISTATE?
10. 在服务器发送数据
   (应该自动收到: +QIURC: "recv",0)
11. AT+QIRD=0,1500
12. AT+QISEND=0,13
   > Hello Server!
13. AT+QICLOSE=0
```

---

## 重点验证项

### ✅ 必须成功的关键步骤:
1. **URC配置**: `AT+QURCCFG="urcport","all"` 返回 OK
2. **网络注册**: `AT+C5GREG?` 或 `AT+CEREG?` 返回 `0,1` 或 `0,5`
3. **获取IPv6**: `AT+CGPADDR` 返回有效的IPv6地址
4. **TCP连接**: `AT+QIOPEN` 后收到 `+QIOPEN: 0,0`
5. **URC通知**: 服务器发送数据后**自动收到** `+QIURC: "recv",0`

### ⚠️ 如果第5步失败:
- 重新执行步骤2: `AT+QURCCFG="urcport","all"`
- 断开重连: `AT+QICLOSE=0` 然后重新 `AT+QIOPEN`
- 检查模块固件版本: `AT+CGMR`

---

## 参考信息

### STM32代码中的初始化顺序
STM32固件按以下顺序执行:
1. 等待15秒硬件启动
2. 发送 `AT` 测试通信
3. 发送 `AT+QURCCFG="urcport","all"` 配置URC到所有端口
4. 发送 `AT+C5GREG?` / `AT+CEREG?` 检查注册
5. 发送 `AT+COPS?` 查询运营商
6. 发送 `AT+QNETDEVCTL=1,1,1` 激活连接
7. 发送 `AT+CGPADDR` 查询IP
8. 发送 `AT+QIOPEN=...` 连接服务器
9. 等待 `+QIOPEN: 0,0` 异步响应
10. 再次发送 `AT+QURCCFG="urcport","all"` 确认URC配置

### 常用查询命令
```
AT+CGMR          - 查询固件版本
AT+CPIN?         - 查询SIM卡状态
AT+CSQ           - 查询信号强度
AT+QNWINFO       - 查询网络信息
AT+QENG="servingcell" - 查询小区信息
```

---

## 测试记录表

| 步骤 | 命令 | 期望响应 | 实际响应 | 结果 |
|------|------|----------|----------|------|
| 1 | AT | OK | | ☐ |
| 2 | AT+QURCCFG="urcport","all" | OK | | ☐ |
| 3 | AT+C5GREG? | +C5GREG: 0,1/5 | | ☐ |
| 4 | AT+CGPADDR | IPv6地址 | | ☐ |
| 5 | AT+QIOPEN=... | OK 然后 +QIOPEN: 0,0 | | ☐ |
| 6 | 服务器发送 | +QIURC: "recv",0 | | ☐ |
| 7 | AT+QIRD=0,1500 | +QIRD: XX\r\n数据 | | ☐ |

---

**测试日期**: ____________

**测试人员**: ____________

**测试结论**: ____________
